package anylayout.extras;

import anylayout.LayoutContext;
import anylayout.SizeCalculator;
import static anylayout.util.Collections.max;
import anylayout.util.DimensionUtility;
import fpeas.function.Function;
import fpeas.pair.Pair;
import fpeas.pair.PairUtility;

import java.awt.Component;
import java.awt.Container;
import java.awt.Dimension;
import java.util.HashMap;
import java.util.Map;

public class PercentConstraintsUtility
{
	private static final Component[] emptyComponents=new Component[0];

	public static PercentConstraints newInstance(final Container container)
	{
		final Function<Pair<Component,Dimension>,Dimension> getPreferredParentSize=new Function<Pair<Component,Dimension>,Dimension>()
		{
			public Dimension run(final Pair<Component, Dimension> pair)
			{
				final Dimension preferredSize=DimensionUtility.multiply(pair.first().getPreferredSize(),100);
				return DimensionUtility.divide(preferredSize,pair.second());
			}
		};

		final Map<Component,Pair<Component,Dimension>> constraints=new HashMap<Component,Pair<Component,Dimension>>();

		return new PercentConstraints()
		{
			public void add(final Component component,final int left,final int top,final int width,final int height,final boolean stretchWidth,final boolean stretchHeight)
			{
				final Pair<Component,Dimension> pair=PairUtility.pair(component,new Dimension(width,height));
				constraints.put(component,pair);

				container.add(component, ConstraintBuilder.buildConstraint().setLeft(new Function<LayoutContext, Integer>()
				{
					public Integer run(final LayoutContext context)
					{
						return context.getParentSize()*left/100;
					}
				}).setTop(new Function<LayoutContext, Integer>()
				{
					public Integer run(final LayoutContext context)
					{
						return context.getParentSize()*top/100;
					}
				}).setWidth(percentSize(stretchWidth, width)).setHeight(percentSize(stretchHeight, height)));
			}

			public SizeCalculator getSizeCalculator()
			{
				return new SizeCalculator()
				{
					public int getHeight()
					{
						return getASize(new Function<Dimension,Integer>()
						{
							public Integer run(final Dimension dimension)
							{
								return dimension.height;
							}
						});
					}

					private int getASize(final Function<Dimension,Integer> dimension)
					{
						return max(new Function<Component,Integer>()
						{
							public Integer run(final Component component)
                                                        {
								return dimension.run(getPreferredParentSize.run(constraints.get(component)));
                                                        }							
						},constraints.keySet().toArray(emptyComponents));
					}

					public int getWidth()
					{
						return getASize(new Function<Dimension,Integer>()
						{
							public Integer run(final Dimension dimension)
							{
								return dimension.width;
							}
						});
					}
				};
			}                        	
		};
	}

	private static Function<LayoutContext,Integer> percentSize(final boolean stretch, final int size)
	{
		return new Function<LayoutContext,Integer>()
		{
			public Integer run(final LayoutContext context)
			{
				if (stretch)
					return context.getParentSize()*size/100;

				return Math.min(context.getParentSize()*size/100,context.getPreferredSize());
			}
		};
	}
}